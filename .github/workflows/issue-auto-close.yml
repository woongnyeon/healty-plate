name: Issue 자동 Close

on:
  pull_request:
    types:
      - closed
    branches:
      # 기능 브랜치가 dev-be 또는 dev-fe로 머지될 때만 실행한다.
      - dev-be
      - dev-fe

jobs:
  close-issue:
    runs-on: ubuntu-latest
    
    # 필수 조건: PR이 성공적으로 Merge 되었을 때만 실행합니다.
    if: github.event.pull_request.merged == true
    
    steps:
    - name: 📝 PR 본문에서 이슈 번호 추출 및 닫기
      shell: bash
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        REPO_NAME=${{ github.repository }}
        TOKEN=${{ secrets.GITHUB_TOKEN }} 

        echo "대상 브랜치: ${{ github.base_ref }}"
        echo "PR 번호: $PR_NUMBER"

        # 1. PR 본문을 API를 통해 가져옵니다.
        PR_URL="https://api.github.com/repos/$REPO_NAME/pulls/$PR_NUMBER"
        PR_BODY=$(curl -s -H "Authorization: token $TOKEN" $PR_URL | jq -r '.body')

        # 2. PR 본문에서 '#숫자' 패턴만 찾아서 이슈 번호를 추출합니다.
        # 💡 수정된 패턴: 공백이나 줄 시작/끝에 있는 '#숫자' 패턴을 찾습니다.
        # 추출된 번호 앞에 붙은 '#' 기호는 제거합니다.
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE "#[0-9]+" | tr -d '#')

        if [[ -z "$ISSUE_NUMBERS" ]]; then
          echo "PR 본문에서 닫을 이슈 번호를 찾지 못했습니다. 작업을 종료합니다."
          exit 0 
        fi

        # 공백 제거 및 중복 이슈 번호 처리 (추출된 번호들이 한 줄에 나열될 경우를 대비)
        # Bash에서 고유한 번호만 추출하기 위해 임시 파일 사용
        UNIQUE_ISSUE_NUMBERS=$(echo "$ISSUE_NUMBERS" | tr ' ' '\n' | sort -u | tr '\n' ' ')

        echo "✅ PR에서 찾은 닫을 이슈 번호들: $UNIQUE_ISSUE_NUMBERS"

        # 3. 추출된 각 이슈 번호에 대해 반복하며 API 호출로 이슈를 닫습니다.
        for ISSUE_NUMBER in $UNIQUE_ISSUE_NUMBERS; do
          # 추출 과정에서 빈 문자열이 포함될 수 있으므로 유효성 재검사
          if [[ -z "$ISSUE_NUMBER" ]]; then
            continue
          fi
          
          echo "-> #$ISSUE_NUMBER 이슈 닫기 시도..."
          API_URL="https://api.github.com/repos/$REPO_NAME/issues/$ISSUE_NUMBER"
          
          # GitHub Issues API를 PATCH 메소드로 호출하여 state를 'closed'로 변경합니다.
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token $TOKEN" -X PATCH "$API_URL" -d '{"state": "closed"}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "-> 성공적으로 #$ISSUE_NUMBER 이슈를 닫았습니다."
          else
            echo "-> ❌ #$ISSUE_NUMBER 이슈 닫기 실패. HTTP Code: $HTTP_CODE"
            # 404 Not Found (이슈가 이미 닫혔거나 존재하지 않는 경우)는 무시하고 진행
            if [[ "$HTTP_CODE" != "404" ]]; then
                echo "-> API 응답 오류로 인해 이슈를 닫지 못했습니다."
            fi
          fi
        done
